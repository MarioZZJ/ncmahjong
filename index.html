<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>南昌麻将记分器</title>
  <meta name="theme-color" content="#b91c1c">
  <link rel="manifest" href="manifest.json">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    :root {
      --red: #b91c1c;
      --red-deep: #991b1b;
      --red-light: #dc2626;
      --gold: #f59e0b;
      --gold-soft: #fbbf24;
      --gold-dim: #d97706;
      --tile: #fef9ef;
      --tile-shadow: #e8dcc6;
      --text-dark: #44403c;
      --text-mid: #78716c;
      --text-light: #a8a29e;
      --bg: #fdf6ee;
      --card-bg: #fff9f0;
      --divider: rgba(0,0,0,0.06);
      --win: #16a34a;
      --lose: #dc2626;
      touch-action: manipulation;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Microsoft YaHei", sans-serif;
      background: var(--bg);
      color: var(--text-dark);
      min-height: 100vh;
      padding-bottom: 110px;
    }

    .header {
      background: var(--red);
      color: var(--gold-soft);
      padding: 18px 20px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(185,28,28,0.3);
    }

    .header h1 { font-size: 24px; font-weight: 800; letter-spacing: 6px; }

    .container { padding: 12px; max-width: 600px; margin: 0 auto; }

    .card {
      background: var(--card-bg);
      border: 1px solid rgba(0,0,0,0.06);
      border-radius: 14px;
      padding: 16px;
      margin-bottom: 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    }

    .card-title {
      font-size: 15px;
      font-weight: 700;
      color: var(--red);
      margin-bottom: 12px;
    }

    .players-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }

    .player-card {
      background: var(--tile);
      border: 1.5px solid var(--tile-shadow);
      border-radius: 10px;
      padding: 12px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }

    .player-name {
      font-size: 15px;
      font-weight: 700;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: var(--text-dark);
    }

    .player-name .badge {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 8px;
      background: var(--red);
      color: #fff;
      font-weight: 700;
    }

    .jing-input-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; }
    .jing-input-row:last-child { margin-bottom: 0; }
    .jing-label { font-size: 14px; color: var(--text-mid); }
    .jing-controls { display: flex; align-items: center; gap: 6px; }

    .jing-btn {
      width: 34px;
      height: 32px;
      border-radius: 8px;
      border: 1.5px solid var(--tile-shadow);
      background: #fff;
      color: var(--text-dark);
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .jing-btn:active { background: var(--gold-soft); border-color: var(--gold); }
    .jing-val { width: 28px; text-align: center; font-size: 18px; font-weight: 800; color: var(--red); }

    .zhuang-selector, .pao-selector { display: flex; gap: 8px; flex-wrap: wrap; }

    .zhuang-btn, .pao-btn {
      flex: 1;
      min-width: 65px;
      padding: 10px 8px;
      border: 1.5px solid var(--divider);
      border-radius: 10px;
      background: #fff;
      color: var(--text-light);
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      text-align: center;
    }

    .zhuang-btn.active {
      border-color: var(--gold);
      background: #fffbeb;
      color: var(--gold-dim);
      font-weight: 700;
    }
    .pao-btn.active {
      border-color: var(--red);
      background: #fef2f2;
      color: var(--red);
      font-weight: 700;
    }

    .hu-types { display: flex; flex-wrap: wrap; gap: 8px; }

    .hu-btn {
      padding: 8px 14px;
      border: 1.5px solid var(--divider);
      border-radius: 10px;
      background: #fff;
      color: var(--text-light);
      font-size: 14px;
      cursor: pointer;
    }

    .hu-btn.active {
      border-color: var(--gold);
      background: #fffbeb;
      color: var(--gold-dim);
      font-weight: 700;
    }

    .bangjin-hint {
      font-size: 13px;
      color: var(--text-light);
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid var(--divider);
    }

    .bangjin-hint.has-bangjin { color: var(--gold-dim); font-weight: 600; }

    .result-card {
      background: var(--red);
      border: none;
      box-shadow: 0 2px 10px rgba(185,28,28,0.2);
    }
    .result-card .card-title { color: var(--gold-soft); }

    .result-table { width: 100%; }
    .result-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid rgba(255,255,255,0.12);
      cursor: pointer;
    }
    .result-row:last-child { border-bottom: none; }
    .result-row.header { cursor: default; font-size: 13px; color: rgba(255,255,255,0.5); }
    .player-col { display: flex; align-items: center; gap: 8px; font-size: 16px; color: #fff; font-weight: 600; }

    .score-col { font-weight: 800; font-size: 20px; min-width: 70px; text-align: right; font-variant-numeric: tabular-nums; color: #fff; }
    .score-col.positive { color: var(--gold-soft); }
    .score-col.negative { color: rgba(255,255,255,0.6); }
    .score-col.zhuang { color: var(--gold-soft); }

    .player-detail {
      display: none;
      padding: 8px 12px;
      background: rgba(0,0,0,0.15);
      border-radius: 8px;
      margin-top: 6px;
      font-size: 13px;
      color: rgba(255,255,255,0.6);
    }

    .player-detail.show { display: block; }
    .player-detail .row { display: flex; justify-content: space-between; padding: 3px 0; }
    .player-detail .row span:last-child { color: rgba(255,255,255,0.85); }

    .total-check {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid rgba(255,255,255,0.12);
      font-size: 13px;
      text-align: center;
      color: rgba(255,255,255,0.5);
    }

    .total-check.valid { color: var(--gold-soft); }
    .total-check.invalid { color: #fca5a5; }

    .action-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #fff;
      padding: 10px 16px;
      padding-bottom: calc(10px + env(safe-area-inset-bottom));
      display: flex;
      gap: 10px;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.08);
    }

    .btn {
      flex: 1;
      padding: 14px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
    }
    .btn-reset {
      background: #f5f5f4;
      color: var(--text-mid);
    }
    .btn-share {
      background: var(--red);
      color: #fff;
    }

    .toast {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(-100px);
      background: var(--text-dark);
      color: #fff;
      padding: 12px 24px;
      border-radius: 24px;
      font-size: 15px;
      font-weight: 600;
      transition: transform 0.3s;
      z-index: 1000;
      box-shadow: 0 4px 16px rgba(0,0,0,0.2);
    }

    .toast.show { transform: translateX(-50%) translateY(0); }

    .section-toggle {
      font-size: 13px;
      color: var(--text-light);
      cursor: pointer;
      float: right;
      padding: 2px 10px;
      border: 1px solid var(--divider);
      border-radius: 6px;
      background: #fff;
    }
    .section-toggle:active { background: #f5f5f4; }
    .gang-section { display: none; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--divider); }
    .gang-section.show { display: block; }

    .hu-explain {
      display: none;
      margin-top: 10px;
      padding: 10px 12px;
      font-size: 13px;
      color: var(--text-mid);
      background: #fef9ef;
      border: 1px solid var(--divider);
      border-radius: 8px;
      line-height: 1.7;
    }
    .hu-explain.show { display: block; }
  </style>
</head>
<body>
  <div class="header"><h1>南昌麻将记分器</h1></div>

  <div class="container">
    <div class="card">
      <div class="card-title">四家精牌 / 杠牌 <button class="section-toggle" id="toggle-gang" onclick="document.querySelectorAll('.gang-section').forEach(s=>s.classList.toggle('show'));this.textContent=this.textContent==='显示杠牌'?'隐藏杠牌':'显示杠牌'">显示杠牌</button></div>
      <div class="players-grid">
        <div class="player-card" data-player="dong">
          <div class="player-name"><span>东家</span><span class="badge" id="dong-badge" style="display:none">庄</span></div>
          <div class="jing-input-row"><span class="jing-label">正精</span><div class="jing-controls"><button class="jing-btn" data-player="dong" data-type="zheng" data-dir="-1">−</button><span class="jing-val" id="dong-zheng">0</span><button class="jing-btn" data-player="dong" data-type="zheng" data-dir="1">+</button></div></div>
          <div class="jing-input-row"><span class="jing-label">副精</span><div class="jing-controls"><button class="jing-btn" data-player="dong" data-type="fu" data-dir="-1">−</button><span class="jing-val" id="dong-fu">0</span><button class="jing-btn" data-player="dong" data-type="fu" data-dir="1">+</button></div></div>
          <div class="gang-section">
            <div class="jing-input-row"><span class="jing-label">明杠</span><div class="jing-controls"><button class="jing-btn" data-player="dong" data-type="minggang" data-dir="-1">−</button><span class="jing-val" id="dong-minggang">0</span><button class="jing-btn" data-player="dong" data-type="minggang" data-dir="1">+</button></div></div>
            <div class="jing-input-row"><span class="jing-label">暗杠</span><div class="jing-controls"><button class="jing-btn" data-player="dong" data-type="angang" data-dir="-1">−</button><span class="jing-val" id="dong-angang">0</span><button class="jing-btn" data-player="dong" data-type="angang" data-dir="1">+</button></div></div>
          </div>
        </div>
        <div class="player-card" data-player="nan">
          <div class="player-name"><span>南家</span><span class="badge" id="nan-badge" style="display:none">庄</span></div>
          <div class="jing-input-row"><span class="jing-label">正精</span><div class="jing-controls"><button class="jing-btn" data-player="nan" data-type="zheng" data-dir="-1">−</button><span class="jing-val" id="nan-zheng">0</span><button class="jing-btn" data-player="nan" data-type="zheng" data-dir="1">+</button></div></div>
          <div class="jing-input-row"><span class="jing-label">副精</span><div class="jing-controls"><button class="jing-btn" data-player="nan" data-type="fu" data-dir="-1">−</button><span class="jing-val" id="nan-fu">0</span><button class="jing-btn" data-player="nan" data-type="fu" data-dir="1">+</button></div></div>
          <div class="gang-section">
            <div class="jing-input-row"><span class="jing-label">明杠</span><div class="jing-controls"><button class="jing-btn" data-player="nan" data-type="minggang" data-dir="-1">−</button><span class="jing-val" id="nan-minggang">0</span><button class="jing-btn" data-player="nan" data-type="minggang" data-dir="1">+</button></div></div>
            <div class="jing-input-row"><span class="jing-label">暗杠</span><div class="jing-controls"><button class="jing-btn" data-player="nan" data-type="angang" data-dir="-1">−</button><span class="jing-val" id="nan-angang">0</span><button class="jing-btn" data-player="nan" data-type="angang" data-dir="1">+</button></div></div>
          </div>
        </div>
        <div class="player-card" data-player="xi">
          <div class="player-name"><span>西家</span><span class="badge" id="xi-badge" style="display:none">庄</span></div>
          <div class="jing-input-row"><span class="jing-label">正精</span><div class="jing-controls"><button class="jing-btn" data-player="xi" data-type="zheng" data-dir="-1">−</button><span class="jing-val" id="xi-zheng">0</span><button class="jing-btn" data-player="xi" data-type="zheng" data-dir="1">+</button></div></div>
          <div class="jing-input-row"><span class="jing-label">副精</span><div class="jing-controls"><button class="jing-btn" data-player="xi" data-type="fu" data-dir="-1">−</button><span class="jing-val" id="xi-fu">0</span><button class="jing-btn" data-player="xi" data-type="fu" data-dir="1">+</button></div></div>
          <div class="gang-section">
            <div class="jing-input-row"><span class="jing-label">明杠</span><div class="jing-controls"><button class="jing-btn" data-player="xi" data-type="minggang" data-dir="-1">−</button><span class="jing-val" id="xi-minggang">0</span><button class="jing-btn" data-player="xi" data-type="minggang" data-dir="1">+</button></div></div>
            <div class="jing-input-row"><span class="jing-label">暗杠</span><div class="jing-controls"><button class="jing-btn" data-player="xi" data-type="angang" data-dir="-1">−</button><span class="jing-val" id="xi-angang">0</span><button class="jing-btn" data-player="xi" data-type="angang" data-dir="1">+</button></div></div>
          </div>
        </div>
        <div class="player-card" data-player="bei">
          <div class="player-name"><span>北家</span><span class="badge" id="bei-badge" style="display:none">庄</span></div>
          <div class="jing-input-row"><span class="jing-label">正精</span><div class="jing-controls"><button class="jing-btn" data-player="bei" data-type="zheng" data-dir="-1">−</button><span class="jing-val" id="bei-zheng">0</span><button class="jing-btn" data-player="bei" data-type="zheng" data-dir="1">+</button></div></div>
          <div class="jing-input-row"><span class="jing-label">副精</span><div class="jing-controls"><button class="jing-btn" data-player="bei" data-type="fu" data-dir="-1">−</button><span class="jing-val" id="bei-fu">0</span><button class="jing-btn" data-player="bei" data-type="fu" data-dir="1">+</button></div></div>
          <div class="gang-section">
            <div class="jing-input-row"><span class="jing-label">明杠</span><div class="jing-controls"><button class="jing-btn" data-player="bei" data-type="minggang" data-dir="-1">−</button><span class="jing-val" id="bei-minggang">0</span><button class="jing-btn" data-player="bei" data-type="minggang" data-dir="1">+</button></div></div>
            <div class="jing-input-row"><span class="jing-label">暗杠</span><div class="jing-controls"><button class="jing-btn" data-player="bei" data-type="angang" data-dir="-1">−</button><span class="jing-val" id="bei-angang">0</span><button class="jing-btn" data-player="bei" data-type="angang" data-dir="1">+</button></div></div>
          </div>
        </div>
      </div>
      <div class="bangjin-hint" id="bangjin-hint">只有一家有精时自动触发霸王精</div>
    </div>

    <div class="card">
      <div class="card-title">庄家</div>
      <div class="zhuang-selector">
        <button class="zhuang-btn" data-zhuang="dong">东家</button>
        <button class="zhuang-btn active" data-zhuang="nan">南家</button>
        <button class="zhuang-btn" data-zhuang="xi">西家</button>
        <button class="zhuang-btn" data-zhuang="bei">北家</button>
      </div>
    </div>

    <div class="card">
      <div class="card-title">胡牌玩家</div>
      <div class="zhuang-selector">
        <button class="hu-btn hu-player" data-hu="dong">东家</button>
        <button class="hu-btn hu-player active" data-hu="nan">南家</button>
        <button class="hu-btn hu-player" data-hu="xi">西家</button>
        <button class="hu-btn hu-player" data-hu="bei">北家</button>
      </div>
    </div>

    <div class="card">
      <div class="card-title">胡牌方式</div>
      <div class="pao-selector">
        <button class="pao-btn" data-pao="dong">东点炮</button>
        <button class="pao-btn" data-pao="nan">南点炮</button>
        <button class="pao-btn" data-pao="xi">西点炮</button>
        <button class="pao-btn" data-pao="bei">北点炮</button>
        <button class="pao-btn active" data-pao="none">自摸</button>
      </div>
    </div>

    <div class="card">
      <div class="card-title">胡牌类型（可多选叠加）</div>
      <div class="hu-types">
        <button class="hu-btn" data-type="qidui">小七对 ×2</button>
        <button class="hu-btn" data-type="dqidui">碰碰胡 ×2</button>
        <button class="hu-btn" data-type="shisanlan">十三烂 ×2</button>
        <button class="hu-btn" data-type="qixing">七星 →×4</button>
        <button class="hu-btn" data-type="jingdiao">精钓 ×2</button>
        <button class="hu-btn" data-type="gangshang">杠上花 ×2</button>
        <button class="hu-btn" data-type="qianggang">抢杠胡 ×2</button>
        <button class="hu-btn" data-type="tianhu">天胡 =20</button>
        <button class="hu-btn" data-type="dihu">地胡 =20</button>
        <button class="hu-btn" data-type="deguo">德国 ×2+5</button>
        <button class="hu-btn" data-type="gangjin">杠精 +10/家</button>
      </div>
      <div class="hu-explain" id="hu-explain"></div>
    </div>

    <div class="card result-card">
      <div class="card-title">结算结果（点击展开明细）</div>
      <div class="result-table">
        <div class="result-row header"><span>玩家</span><span style="text-align:right">进出子</span></div>

        <div class="result-row" data-player="dong">
          <div class="player-col"><span>东家</span><span class="badge" id="res-dong-badge" style="display:none">庄</span></div>
          <span class="score-col" id="res-dong">0</span>
        </div>
        <div class="player-detail" id="detail-dong"></div>

        <div class="result-row" data-player="nan">
          <div class="player-col"><span>南家</span><span class="badge" id="res-nan-badge" style="display:none">庄</span></div>
          <span class="score-col" id="res-nan">0</span>
        </div>
        <div class="player-detail" id="detail-nan"></div>

        <div class="result-row" data-player="xi">
          <div class="player-col"><span>西家</span><span class="badge" id="res-xi-badge" style="display:none">庄</span></div>
          <span class="score-col" id="res-xi">0</span>
        </div>
        <div class="player-detail" id="detail-xi"></div>

        <div class="result-row" data-player="bei">
          <div class="player-col"><span>北家</span><span class="badge" id="res-bei-badge" style="display:none">庄</span></div>
          <span class="score-col" id="res-bei">0</span>
        </div>
        <div class="player-detail" id="detail-bei"></div>
      </div>

      <div class="total-check" id="total-check">总计: 0</div>
    </div>
  </div>

  <div class="action-bar">
    <button class="btn btn-reset" id="btn-reset">重置</button>
    <button class="btn btn-share" id="btn-share">复制战绩</button>
  </div>

  <div class="toast" id="toast">已复制到剪贴板</div>

  <script>
    const players = ['dong', 'nan', 'xi', 'bei'];
    const playerNames = { dong: '东', nan: '南', xi: '西', bei: '北' };

    let state = {
      zhuang: 'nan',
      hu: 'nan',
      pao: 'none',
      huTypes: new Set(),
      players: {
        dong: { zheng: 0, fu: 0, minggang: 0, angang: 0 },
        nan:  { zheng: 0, fu: 0, minggang: 0, angang: 0 },
        xi:   { zheng: 0, fu: 0, minggang: 0, angang: 0 },
        bei:  { zheng: 0, fu: 0, minggang: 0, angang: 0 }
      }
    };

    function calculate() {
      const results = {};
      const details = {};
      players.forEach(p => { results[p] = 0; details[p] = []; });

      const winner = state.hu;
      const dealer = state.zhuang;
      const isZimo = state.pao === 'none';
      const paoPlayer = state.pao;

      // ========== 1. 精牌分 ==========
      const jingBase = {};
      let totalJingBase = 0;
      const playersWithJing = [];

      players.forEach(p => {
        jingBase[p] = state.players[p].zheng * 2 + state.players[p].fu;
        totalJingBase += jingBase[p];
        if (jingBase[p] > 0) playersWithJing.push(p);
      });

      const isBawang = playersWithJing.length === 1;

      // 冲关倍数：总精分>=5时，倍数=总精分-3
      const chongguanMulti = totalJingBase >= 5 ? (totalJingBase - 3) : 1;

      // 计算每家精牌得分（冲关+霸王精后）
      const jingScore = {};
      players.forEach(p => {
        jingScore[p] = jingBase[p];
        if (jingScore[p] > 0) {
          jingScore[p] *= chongguanMulti;
          if (isBawang) jingScore[p] *= 2;
        }
      });

      const totalJingScore = players.reduce((s, p) => s + jingScore[p], 0);

      // 精牌结算：每家净分 = 4×自己分 - 总分（保证总和为0）
      players.forEach(p => {
        const net = 4 * jingScore[p] - totalJingScore;
        results[p] += net;
        if (net !== 0) {
          let desc = `精牌${jingBase[p]}子`;
          if (chongguanMulti > 1) desc += ` 冲关×${chongguanMulti}`;
          if (isBawang && jingScore[p] > 0) desc += ' 霸王×2';
          details[p].push(`精牌: ${net > 0 ? '+' : ''}${net} (${desc})`);
        }
      });

      // 更新霸王精提示
      const hint = document.getElementById('bangjin-hint');
      if (isBawang) {
        hint.textContent = '霸王精：' + playerNames[playersWithJing[0]] + '家（精分翻倍）';
        hint.classList.add('has-bangjin');
      } else if (chongguanMulti > 1) {
        hint.textContent = '冲关：总精' + totalJingBase + '子 ×' + chongguanMulti;
        hint.classList.add('has-bangjin');
      } else {
        hint.textContent = '只有一家有精时自动触发霸王精';
        hint.classList.remove('has-bangjin');
      }

      // ========== 2. 杠分 ==========
      // 明杠：其他3家各付1子/杠，暗杠：其他3家各付2子/杠
      players.forEach(p => {
        const myGangPer = state.players[p].minggang * 1 + state.players[p].angang * 2;
        if (myGangPer > 0) {
          const income = myGangPer * 3;
          results[p] += income;
          const gangDesc = [];
          if (state.players[p].minggang > 0) gangDesc.push(`明杠${state.players[p].minggang}`);
          if (state.players[p].angang > 0) gangDesc.push(`暗杠${state.players[p].angang}`);
          details[p].push(`杠牌: +${income} (${gangDesc.join('+')})`);
        }
        // 付给其他杠者
        players.forEach(q => {
          if (q === p) return;
          const qGangPer = state.players[q].minggang * 1 + state.players[q].angang * 2;
          if (qGangPer > 0) {
            results[p] -= qGangPer;
          }
        });
      });
      // 修正杠的details（付出部分合并显示）
      players.forEach(p => {
        const myGangPer = state.players[p].minggang * 1 + state.players[p].angang * 2;
        const othersGang = players.filter(q => q !== p)
          .reduce((s, q) => s + state.players[q].minggang * 1 + state.players[q].angang * 2, 0);
        if (othersGang > 0 && myGangPer === 0) {
          details[p].push(`杠牌: -${othersGang}`);
        }
      });

      // 杠精：胡牌者杠了精牌，其他3家各付10
      if (state.huTypes.has('gangjin')) {
        results[winner] += 30;
        details[winner].push('杠精: +30');
        players.forEach(p => {
          if (p !== winner) {
            results[p] -= 10;
            details[p].push('杠精: -10');
          }
        });
      }

      // ========== 3. 胡牌分 ==========
      const hasTianhu = state.huTypes.has('tianhu');
      const hasDihu = state.huTypes.has('dihu');
      const hasDeguo = state.huTypes.has('deguo');
      const hasJingdiao = state.huTypes.has('jingdiao');
      const hasQidui = state.huTypes.has('qidui');
      const hasDqidui = state.huTypes.has('dqidui');
      const hasShisanlan = state.huTypes.has('shisanlan');
      const hasQixing = state.huTypes.has('qixing');
      const hasGangshang = state.huTypes.has('gangshang');
      const hasQianggang = state.huTypes.has('qianggang');

      if (hasTianhu || hasDihu) {
        // 天胡/地胡：固定金额，每家付20（精钓时40）
        let fixedPer = 20;
        if (hasJingdiao) fixedPer = 40;

        const huLabel = hasTianhu ? '天胡' : '地胡';
        let winnerTotal = 0;
        players.forEach(p => {
          if (p !== winner) {
            results[p] -= fixedPer;
            results[winner] += fixedPer;
            winnerTotal += fixedPer;
            details[p].push(`${huLabel}: -${fixedPer}`);
          }
        });
        details[winner].push(`${huLabel}: +${winnerTotal}`);
      } else {
        // 计算牌型倍数
        let typeMult = 1;
        const typeDesc = [];

        // 自摸 ×2（由胡牌方式决定，非胡牌类型选择）
        if (isZimo) {
          typeMult *= 2;
          typeDesc.push('自摸×2');
        }

        // 七星+七对/十三烂 = ×4（不是各自独立叠加）
        if (hasQixing && (hasQidui || hasDqidui)) {
          typeMult *= 4;
          typeDesc.push('七星七对×4');
        } else if (hasQixing && hasShisanlan) {
          typeMult *= 4;
          typeDesc.push('七星十三烂×4');
        } else {
          if (hasQidui) { typeMult *= 2; typeDesc.push('小七对×2'); }
          if (hasDqidui) { typeMult *= 2; typeDesc.push('碰碰胡×2'); }
          if (hasShisanlan) { typeMult *= 2; typeDesc.push('十三烂×2'); }
          if (hasQixing) { typeMult *= 4; typeDesc.push('七星×4'); }
        }

        if (hasJingdiao) { typeMult *= 2; typeDesc.push('精钓×2'); }
        if (hasGangshang) { typeMult *= 2; typeDesc.push('杠上花×2'); }
        if (hasQianggang) { typeMult *= 2; typeDesc.push('抢杠×2'); }
        if (hasDeguo) { typeMult *= 2; typeDesc.push('德国×2'); }

        // 基础胡牌分 = 1 × 牌型倍数
        const huScore = typeMult;
        const typeDescStr = typeDesc.length > 0 ? typeDesc.join(' ') : '屁胡';

        if (isZimo) {
          // === 自摸结算：三家都付 ===
          let winnerTotal = 0;
          players.forEach(p => {
            if (p === winner) return;
            let amount = huScore;
            let extra = '';
            // 庄家修饰：涉及庄家的付款翻倍
            if (p === dealer || winner === dealer) {
              amount *= 2;
              extra = ' 庄×2';
            }
            // 德国额外+5
            if (hasDeguo) {
              amount += 5;
              extra += ' +5';
            }
            results[p] -= amount;
            results[winner] += amount;
            winnerTotal += amount;
            details[p].push(`胡牌: -${amount} (${typeDescStr}${extra})`);
          });
          details[winner].push(`胡牌: +${winnerTotal} (${typeDescStr})`);
        } else if (hasDeguo) {
          // === 德国点炮：三家都付，点炮者额外×2+5 ===
          let winnerTotal = 0;
          players.forEach(p => {
            if (p === winner) return;
            let amount = huScore;
            let extra = '';
            if (p === paoPlayer) {
              amount *= 2; // 点炮 ×2
              extra = ' 点炮×2';
            }
            // 庄家修饰
            if (p === dealer || winner === dealer) {
              amount *= 2;
              extra += ' 庄×2';
            }
            // 德国+5（仅点炮者）
            if (p === paoPlayer) {
              amount += 5;
              extra += ' +5';
            }
            results[p] -= amount;
            results[winner] += amount;
            winnerTotal += amount;
            details[p].push(`胡牌: -${amount} (${typeDescStr}${extra})`);
          });
          details[winner].push(`胡牌: +${winnerTotal} (${typeDescStr})`);
        } else {
          // === 普通点炮：仅点炮者付款 ===
          if (paoPlayer && paoPlayer !== 'none') {
            let amount = huScore * 2; // 点炮 ×2
            let extra = '点炮×2';
            // 庄家修饰
            if (paoPlayer === dealer || winner === dealer) {
              amount *= 2;
              extra += ' 庄×2';
            }
            results[paoPlayer] -= amount;
            results[winner] += amount;
            details[paoPlayer].push(`点炮: -${amount} (${typeDescStr} ${extra})`);
            details[winner].push(`胡牌: +${amount} (${typeDescStr} ${extra})`);
          }
        }
      }

      updateResults(results, details);
    }

    function updateResults(results, details) {
      let total = 0;

      players.forEach(p => {
        const s = results[p];
        total += s;

        const el = document.getElementById('res-' + p);
        el.textContent = (s >= 0 ? '+' : '') + s;
        el.className = 'score-col ' + (s > 0 ? 'positive' : s < 0 ? 'negative' : '') + (p === state.zhuang ? ' zhuang' : '');

        const detailEl = document.getElementById('detail-' + p);
        if (details[p].length > 0) {
          detailEl.innerHTML = details[p].map(d => `<div class="row"><span>${d}</span></div>`).join('');
        } else {
          detailEl.innerHTML = '<div class="row"><span>无变动</span></div>';
        }
      });

      // 庄家标记
      players.forEach(p => {
        document.getElementById(p + '-badge').style.display = (p === state.zhuang) ? 'inline' : 'none';
        document.getElementById('res-' + p + '-badge').style.display = (p === state.zhuang) ? 'inline' : 'none';
      });

      const totalEl = document.getElementById('total-check');
      totalEl.textContent = '总计: ' + total + (total === 0 ? ' \u2713' : ' \u2717 (计算异常)');
      totalEl.className = 'total-check ' + (total === 0 ? 'valid' : 'invalid');
    }

    // 精牌/杠牌按钮事件
    document.querySelectorAll('.jing-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const p = btn.dataset.player, t = btn.dataset.type, d = parseInt(btn.dataset.dir);
        const max = (t === 'zheng' || t === 'fu') ? 4 : 10;
        state.players[p][t] = Math.max(0, Math.min(max, state.players[p][t] + d));
        document.getElementById(p + '-' + t).textContent = state.players[p][t];
        calculate();
      });
    });

    // 庄家选择
    document.querySelectorAll('.zhuang-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.zhuang-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        state.zhuang = btn.dataset.zhuang;
        calculate();
      });
    });

    // 点炮选择
    document.querySelectorAll('.pao-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.pao-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        state.pao = btn.dataset.pao;
        calculate();
      });
    });

    // 胡牌玩家选择
    document.querySelectorAll('.hu-player').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.hu-player').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        state.hu = btn.dataset.hu;
        calculate();
      });
    });

    // 胡牌类型（互斥处理）
    const exclusiveGroups = {
      qidui: ['dqidui', 'shisanlan'],
      dqidui: ['qidui', 'shisanlan'],
      shisanlan: ['qidui', 'dqidui'],
      tianhu: ['dihu'],
      dihu: ['tianhu']
    };

    const huExplains = {
      qidui: '小七对：手牌由7组对子组成，不能有吃碰杠。胡牌倍数×2。',
      dqidui: '碰碰胡：4组刻子（或杠）+ 1对雀头，没有顺子。胡牌倍数×2。',
      shisanlan: '十三烂：万条筒每张牌在同花色中间隔≥2，字牌不重复，不能吃碰杠。胡牌倍数×2。',
      qixing: '七星：在小七对或十三烂基础上，集齐东南西北中发白7张字牌。胡牌倍数×4（替代基础牌型的×2）。',
      jingdiao: '精钓：手中只剩1张牌时胡牌，且该牌为精牌（万能牌）。胡牌倍数×2，叠加自摸。',
      gangshang: '杠上开花：杠牌后补牌时自摸胡牌。胡牌倍数×2，叠加自摸。',
      qianggang: '抢杠胡：其他玩家补杠时，你恰好能胡该牌。胡牌倍数×2。',
      tianhu: '天胡：庄家起手14张直接胡牌。固定每家付20子（精钓时40子）。',
      dihu: '地胡：庄家打出的第一张牌被闲家胡。固定每家付20子（精钓时40子）。',
      deguo: '德国：胡牌时手中无精牌，或精牌未当万能牌使用。自摸三家各+5，点炮时三家都付、点炮者额外×2+5。',
      gangjin: '杠精：将4张精牌开杠。其他三家各付10子（独立于胡牌分计算）。'
    };

    const explainEl = document.getElementById('hu-explain');

    document.querySelectorAll('.hu-btn:not(.hu-player)').forEach(btn => {
      btn.addEventListener('click', () => {
        const t = btn.dataset.type;
        if (state.huTypes.has(t)) {
          // 取消选中 → 隐藏解释
          state.huTypes.delete(t);
          btn.classList.remove('active');
          explainEl.classList.remove('show');
        } else {
          // 选中 → 显示该类型解释
          state.huTypes.add(t);
          btn.classList.add('active');
          if (huExplains[t]) {
            explainEl.textContent = huExplains[t];
            explainEl.classList.add('show');
          }
          // 处理互斥
          if (exclusiveGroups[t]) {
            exclusiveGroups[t].forEach(ex => {
              state.huTypes.delete(ex);
              document.querySelector(`.hu-btn[data-type="${ex}"]`).classList.remove('active');
            });
          }
        }
        calculate();
      });
    });

    // 点击展开明细
    document.querySelectorAll('.result-row[data-player]').forEach(row => {
      row.addEventListener('click', () => {
        const p = row.dataset.player;
        document.getElementById('detail-' + p).classList.toggle('show');
      });
    });

    // 重置
    document.getElementById('btn-reset').addEventListener('click', () => {
      state = {
        zhuang: 'nan', hu: 'nan', pao: 'none', huTypes: new Set(),
        players: {
          dong: { zheng: 0, fu: 0, minggang: 0, angang: 0 },
          nan:  { zheng: 0, fu: 0, minggang: 0, angang: 0 },
          xi:   { zheng: 0, fu: 0, minggang: 0, angang: 0 },
          bei:  { zheng: 0, fu: 0, minggang: 0, angang: 0 }
        }
      };
      players.forEach(p => {
        ['zheng', 'fu', 'minggang', 'angang'].forEach(t => {
          document.getElementById(p + '-' + t).textContent = 0;
        });
      });
      document.querySelectorAll('.zhuang-btn').forEach(b => b.classList.remove('active'));
      document.querySelector('.zhuang-btn[data-zhuang="nan"]').classList.add('active');
      document.querySelectorAll('.hu-player').forEach(b => b.classList.remove('active'));
      document.querySelector('.hu-player[data-hu="nan"]').classList.add('active');
      document.querySelectorAll('.pao-btn').forEach(b => b.classList.remove('active'));
      document.querySelector('.pao-btn[data-pao="none"]').classList.add('active');
      document.querySelectorAll('.hu-btn:not(.hu-player)').forEach(b => b.classList.remove('active'));
      document.getElementById('hu-explain').classList.remove('show');
      document.querySelectorAll('.player-detail').forEach(d => d.classList.remove('show'));
      document.querySelectorAll('.gang-section').forEach(s => s.classList.remove('show'));
      document.getElementById('toggle-gang').textContent = '显示杠牌';
      calculate();
    });

    // 复制战绩
    document.getElementById('btn-share').addEventListener('click', async () => {
      const lines = ['南昌麻将结算', '────────'];
      players.forEach(p => {
        const s = document.getElementById('res-' + p).textContent;
        const z = p === state.zhuang ? ' [庄]' : '';
        const h = p === state.hu ? ' [胡]' : '';
        lines.push(playerNames[p] + '家' + z + h + ': ' + s);
      });
      lines.push('────────');
      const method = state.pao === 'none' ? '自摸' : playerNames[state.pao] + '点炮';
      lines.push('庄:' + playerNames[state.zhuang] + ' 胡:' + playerNames[state.hu] + ' ' + method);
      if (state.huTypes.size > 0) {
        const typeLabels = {
          qidui:'小七对', dqidui:'碰碰胡', shisanlan:'十三烂', qixing:'七星',
          jingdiao:'精钓', gangshang:'杠上花', qianggang:'抢杠胡',
          tianhu:'天胡', dihu:'地胡', deguo:'德国', gangjin:'杠精'
        };
        lines.push('类型: ' + Array.from(state.huTypes).map(t => typeLabels[t] || t).join(', '));
      }

      try {
        await navigator.clipboard.writeText(lines.join('\n'));
        const toast = document.getElementById('toast');
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 2000);
      } catch(e) {}
    });

    calculate();
  </script>
</body>
</html>
