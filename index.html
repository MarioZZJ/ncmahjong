<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>å—æ˜Œéº»å°†è®°åˆ†å™¨</title>
  <meta name="theme-color" content="#1b4332" id="meta-theme">
  <link rel="manifest" href="manifest.json">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    /* ===== ä¸»é¢˜å˜é‡ ===== */
    :root, [data-theme="mahjong"] {
      --bg: #1b4332; --card: #234f3e; --card-result: #132e22;
      --header: #2d6a4f; --header-text: #d4edda; --bar: #1b4332;
      --text: #e8e0cc; --text-mid: #b8b0a0; --text-mute: #8a8274;
      --accent: #c9a84c; --accent-bg: rgba(201,168,76,0.15); --accent-text: #c9a84c;
      --danger: #e07a5f; --danger-bg: rgba(224,122,95,0.15); --danger-text: #e07a5f;
      --win: #a7d489; --lose: #e07a5f;
      --tile: rgba(255,255,255,0.06); --tile-border: rgba(255,255,255,0.1);
      --btn-bg: rgba(255,255,255,0.08); --btn-text: #b8b0a0;
      --jing-btn-bg: #e8e0cc; --jing-btn-text: #2d3a2e; --jing-val: #c9a84c;
      --badge-bg: #c9a84c; --badge-text: #1b4332;
      --divider: rgba(255,255,255,0.08);
      --result-text: #e8e0cc; --result-head: rgba(255,255,255,0.4);
      --result-detail-bg: rgba(0,0,0,0.2); --result-detail: rgba(255,255,255,0.5); --result-detail-val: rgba(255,255,255,0.8);
      --result-border: rgba(255,255,255,0.1);
      --share-bg: #c9a84c; --share-text: #1b4332; --reset-bg: rgba(255,255,255,0.1); --reset-text: #b8b0a0;
      --toast-bg: #2d6a4f; --toast-text: #e8e0cc;
      --explain-bg: rgba(0,0,0,0.15); --explain-text: #8a8274;
    }

    [data-theme="festive"] {
      --bg: #fdf6ee; --card: #fff9f0; --card-result: #b91c1c;
      --header: #b91c1c; --header-text: #fbbf24; --bar: #fff;
      --text: #44403c; --text-mid: #78716c; --text-mute: #a8a29e;
      --accent: #d97706; --accent-bg: #fffbeb; --accent-text: #d97706;
      --danger: #b91c1c; --danger-bg: #fef2f2; --danger-text: #b91c1c;
      --win: #fbbf24; --lose: rgba(255,255,255,0.55);
      --tile: #fef9ef; --tile-border: #e8dcc6;
      --btn-bg: #fff; --btn-text: #a8a29e;
      --jing-btn-bg: #fff; --jing-btn-text: #44403c; --jing-val: #b91c1c;
      --badge-bg: #b91c1c; --badge-text: #fff;
      --divider: rgba(0,0,0,0.06);
      --result-text: #fff; --result-head: rgba(255,255,255,0.5);
      --result-detail-bg: rgba(0,0,0,0.12); --result-detail: rgba(255,255,255,0.55); --result-detail-val: rgba(255,255,255,0.85);
      --result-border: rgba(255,255,255,0.12);
      --share-bg: #b91c1c; --share-text: #fff; --reset-bg: #f5f5f4; --reset-text: #78716c;
      --toast-bg: #44403c; --toast-text: #fff;
      --explain-bg: #fef9ef; --explain-text: #78716c;
    }

    [data-theme="dark"] {
      --bg: #18181b; --card: #27272a; --card-result: #1e1e22;
      --header: #27272a; --header-text: #e4e4e7; --bar: #27272a;
      --text: #e4e4e7; --text-mid: #a1a1aa; --text-mute: #71717a;
      --accent: #60a5fa; --accent-bg: rgba(96,165,250,0.12); --accent-text: #60a5fa;
      --danger: #f87171; --danger-bg: rgba(248,113,113,0.12); --danger-text: #f87171;
      --win: #4ade80; --lose: #f87171;
      --tile: rgba(255,255,255,0.04); --tile-border: rgba(255,255,255,0.08);
      --btn-bg: rgba(255,255,255,0.06); --btn-text: #71717a;
      --jing-btn-bg: #3f3f46; --jing-btn-text: #e4e4e7; --jing-val: #60a5fa;
      --badge-bg: #60a5fa; --badge-text: #18181b;
      --divider: rgba(255,255,255,0.06);
      --result-text: #e4e4e7; --result-head: rgba(255,255,255,0.35);
      --result-detail-bg: rgba(0,0,0,0.3); --result-detail: rgba(255,255,255,0.4); --result-detail-val: rgba(255,255,255,0.75);
      --result-border: rgba(255,255,255,0.08);
      --share-bg: #3f3f46; --share-text: #e4e4e7; --reset-bg: rgba(255,255,255,0.06); --reset-text: #a1a1aa;
      --toast-bg: #3f3f46; --toast-text: #e4e4e7;
      --explain-bg: rgba(255,255,255,0.04); --explain-text: #71717a;
    }

    /* ===== å¸ƒå±€ ===== */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Microsoft YaHei", sans-serif;
      background: var(--bg); color: var(--text);
      min-height: 100vh; padding-bottom: 110px;
      transition: background 0.3s, color 0.3s;
    }

    .header {
      background: var(--header); color: var(--header-text);
      padding: 18px 20px; text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      position: relative;
    }
    .header h1 { font-size: 24px; font-weight: 800; letter-spacing: 6px; }

    .theme-toggle {
      position: absolute; right: 14px; top: 50%; transform: translateY(-50%);
      background: rgba(255,255,255,0.15); border: none; border-radius: 8px;
      color: inherit; font-size: 18px; width: 36px; height: 36px;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
    }
    .theme-toggle:active { background: rgba(255,255,255,0.25); }

    .container { padding: 12px; max-width: 600px; margin: 0 auto; }

    .card {
      background: var(--card); border: 1px solid var(--divider);
      border-radius: 14px; padding: 16px; margin-bottom: 10px;
      transition: background 0.3s;
    }

    .card-title { font-size: 15px; font-weight: 700; color: var(--accent-text); margin-bottom: 12px; }

    .players-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }

    .player-card {
      background: var(--tile); border: 1.5px solid var(--tile-border);
      border-radius: 10px; padding: 12px;
    }

    .player-name {
      font-size: 15px; font-weight: 700; margin-bottom: 10px;
      display: flex; justify-content: space-between; align-items: center;
    }
    .player-name .badge {
      font-size: 11px; padding: 2px 8px; border-radius: 8px;
      background: var(--badge-bg); color: var(--badge-text); font-weight: 700;
    }

    .jing-input-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; }
    .jing-input-row:last-child { margin-bottom: 0; }
    .jing-label { font-size: 14px; color: var(--text-mid); }
    .jing-controls { display: flex; align-items: center; gap: 6px; }

    .jing-btn {
      width: 34px; height: 32px; border-radius: 8px;
      border: 1px solid var(--tile-border);
      background: var(--jing-btn-bg); color: var(--jing-btn-text);
      font-size: 18px; font-weight: 600; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .jing-btn:active { opacity: 0.7; }
    .jing-val { width: 28px; text-align: center; font-size: 18px; font-weight: 800; color: var(--jing-val); }

    .zhuang-selector, .pao-selector { display: flex; gap: 8px; flex-wrap: wrap; }

    .zhuang-btn, .pao-btn {
      flex: 1; min-width: 65px; padding: 10px 8px;
      border: 1.5px solid var(--divider); border-radius: 10px;
      background: var(--btn-bg); color: var(--btn-text);
      font-size: 15px; font-weight: 500; cursor: pointer; text-align: center;
    }
    .zhuang-btn.active { border-color: var(--accent); background: var(--accent-bg); color: var(--accent-text); font-weight: 700; }
    .pao-btn.active { border-color: var(--danger); background: var(--danger-bg); color: var(--danger-text); font-weight: 700; }

    .hu-types { display: flex; flex-wrap: wrap; gap: 8px; }

    .hu-btn {
      padding: 8px 14px; border: 1.5px solid var(--divider); border-radius: 10px;
      background: var(--btn-bg); color: var(--btn-text); font-size: 14px; cursor: pointer;
    }
    .hu-btn.active { border-color: var(--accent); background: var(--accent-bg); color: var(--accent-text); font-weight: 700; }

    .bangjin-hint { font-size: 13px; color: var(--text-mute); margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--divider); }
    .bangjin-hint.has-bangjin { color: var(--accent-text); font-weight: 600; }

    .result-card { background: var(--card-result); border: 1px solid var(--result-border); }
    .result-card .card-title { color: var(--win); }

    .result-table { width: 100%; }
    .result-row {
      display: flex; justify-content: space-between; align-items: center;
      padding: 12px 0; border-bottom: 1px solid var(--result-border); cursor: pointer;
    }
    .result-row:last-child { border-bottom: none; }
    .result-row.header { cursor: default; font-size: 13px; color: var(--result-head); }
    .player-col { display: flex; align-items: center; gap: 8px; font-size: 16px; color: var(--result-text); font-weight: 600; }

    .score-col { font-weight: 800; font-size: 20px; min-width: 70px; text-align: right; font-variant-numeric: tabular-nums; color: var(--result-text); }
    .score-col.positive { color: var(--win); }
    .score-col.negative { color: var(--lose); }

    .player-detail {
      display: none; padding: 8px 12px; background: var(--result-detail-bg);
      border-radius: 8px; margin-top: 6px; font-size: 13px; color: var(--result-detail);
    }
    .player-detail.show { display: block; }
    .player-detail .row { display: flex; justify-content: space-between; padding: 3px 0; }
    .player-detail .row span:last-child { color: var(--result-detail-val); }

    .total-check {
      margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--result-border);
      font-size: 13px; text-align: center; color: var(--result-head);
    }
    .total-check.valid { color: var(--win); }
    .total-check.invalid { color: var(--lose); }

    .action-bar {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: var(--bar); padding: 10px 16px;
      padding-bottom: calc(10px + env(safe-area-inset-bottom));
      display: flex; gap: 10px;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      border-top: 1px solid var(--divider);
    }

    .btn { flex: 1; padding: 14px; border: none; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; }
    .btn-reset { background: var(--reset-bg); color: var(--reset-text); }
    .btn-share { background: var(--share-bg); color: var(--share-text); }

    .toast {
      position: fixed; top: 20px; left: 50%;
      transform: translateX(-50%) translateY(-100px);
      background: var(--toast-bg); color: var(--toast-text);
      padding: 12px 24px; border-radius: 24px;
      font-size: 15px; font-weight: 600;
      transition: transform 0.3s; z-index: 1000;
      box-shadow: 0 4px 16px rgba(0,0,0,0.2);
    }
    .toast.show { transform: translateX(-50%) translateY(0); }

    .section-toggle {
      font-size: 13px; color: var(--text-mute); cursor: pointer; float: right;
      padding: 2px 10px; border: 1px solid var(--divider); border-radius: 6px;
      background: var(--btn-bg);
    }
    .section-toggle:active { opacity: 0.7; }
    .gang-section { display: none; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--divider); }
    .gang-section.show { display: block; }

    .hu-explain {
      display: none; margin-top: 10px; padding: 10px 12px;
      font-size: 13px; color: var(--explain-text);
      background: var(--explain-bg); border-radius: 8px; line-height: 1.7;
    }
    .hu-explain.show { display: block; }
  </style>
</head>
<body>
  <div class="header"><h1>å—æ˜Œéº»å°†è®°åˆ†å™¨</h1><button class="theme-toggle" id="theme-toggle">ğŸ¨</button></div>

  <div class="container">
    <div class="card">
      <div class="card-title">å››å®¶ç²¾ç‰Œ / æ ç‰Œ <button class="section-toggle" id="toggle-gang" onclick="document.querySelectorAll('.gang-section').forEach(s=>s.classList.toggle('show'));this.textContent=this.textContent==='æ˜¾ç¤ºæ ç‰Œ'?'éšè—æ ç‰Œ':'æ˜¾ç¤ºæ ç‰Œ'">æ˜¾ç¤ºæ ç‰Œ</button></div>
      <div class="players-grid">
        <div class="player-card" data-player="dong">
          <div class="player-name"><span>ä¸œå®¶</span><span class="badge" id="dong-badge" style="display:none">åº„</span></div>
          <div class="jing-input-row"><span class="jing-label">æ­£ç²¾</span><div class="jing-controls"><button class="jing-btn" data-player="dong" data-type="zheng" data-dir="-1">âˆ’</button><span class="jing-val" id="dong-zheng">0</span><button class="jing-btn" data-player="dong" data-type="zheng" data-dir="1">+</button></div></div>
          <div class="jing-input-row"><span class="jing-label">å‰¯ç²¾</span><div class="jing-controls"><button class="jing-btn" data-player="dong" data-type="fu" data-dir="-1">âˆ’</button><span class="jing-val" id="dong-fu">0</span><button class="jing-btn" data-player="dong" data-type="fu" data-dir="1">+</button></div></div>
          <div class="gang-section">
            <div class="jing-input-row"><span class="jing-label">æ˜æ </span><div class="jing-controls"><button class="jing-btn" data-player="dong" data-type="minggang" data-dir="-1">âˆ’</button><span class="jing-val" id="dong-minggang">0</span><button class="jing-btn" data-player="dong" data-type="minggang" data-dir="1">+</button></div></div>
            <div class="jing-input-row"><span class="jing-label">æš—æ </span><div class="jing-controls"><button class="jing-btn" data-player="dong" data-type="angang" data-dir="-1">âˆ’</button><span class="jing-val" id="dong-angang">0</span><button class="jing-btn" data-player="dong" data-type="angang" data-dir="1">+</button></div></div>
          </div>
        </div>
        <div class="player-card" data-player="nan">
          <div class="player-name"><span>å—å®¶</span><span class="badge" id="nan-badge" style="display:none">åº„</span></div>
          <div class="jing-input-row"><span class="jing-label">æ­£ç²¾</span><div class="jing-controls"><button class="jing-btn" data-player="nan" data-type="zheng" data-dir="-1">âˆ’</button><span class="jing-val" id="nan-zheng">0</span><button class="jing-btn" data-player="nan" data-type="zheng" data-dir="1">+</button></div></div>
          <div class="jing-input-row"><span class="jing-label">å‰¯ç²¾</span><div class="jing-controls"><button class="jing-btn" data-player="nan" data-type="fu" data-dir="-1">âˆ’</button><span class="jing-val" id="nan-fu">0</span><button class="jing-btn" data-player="nan" data-type="fu" data-dir="1">+</button></div></div>
          <div class="gang-section">
            <div class="jing-input-row"><span class="jing-label">æ˜æ </span><div class="jing-controls"><button class="jing-btn" data-player="nan" data-type="minggang" data-dir="-1">âˆ’</button><span class="jing-val" id="nan-minggang">0</span><button class="jing-btn" data-player="nan" data-type="minggang" data-dir="1">+</button></div></div>
            <div class="jing-input-row"><span class="jing-label">æš—æ </span><div class="jing-controls"><button class="jing-btn" data-player="nan" data-type="angang" data-dir="-1">âˆ’</button><span class="jing-val" id="nan-angang">0</span><button class="jing-btn" data-player="nan" data-type="angang" data-dir="1">+</button></div></div>
          </div>
        </div>
        <div class="player-card" data-player="xi">
          <div class="player-name"><span>è¥¿å®¶</span><span class="badge" id="xi-badge" style="display:none">åº„</span></div>
          <div class="jing-input-row"><span class="jing-label">æ­£ç²¾</span><div class="jing-controls"><button class="jing-btn" data-player="xi" data-type="zheng" data-dir="-1">âˆ’</button><span class="jing-val" id="xi-zheng">0</span><button class="jing-btn" data-player="xi" data-type="zheng" data-dir="1">+</button></div></div>
          <div class="jing-input-row"><span class="jing-label">å‰¯ç²¾</span><div class="jing-controls"><button class="jing-btn" data-player="xi" data-type="fu" data-dir="-1">âˆ’</button><span class="jing-val" id="xi-fu">0</span><button class="jing-btn" data-player="xi" data-type="fu" data-dir="1">+</button></div></div>
          <div class="gang-section">
            <div class="jing-input-row"><span class="jing-label">æ˜æ </span><div class="jing-controls"><button class="jing-btn" data-player="xi" data-type="minggang" data-dir="-1">âˆ’</button><span class="jing-val" id="xi-minggang">0</span><button class="jing-btn" data-player="xi" data-type="minggang" data-dir="1">+</button></div></div>
            <div class="jing-input-row"><span class="jing-label">æš—æ </span><div class="jing-controls"><button class="jing-btn" data-player="xi" data-type="angang" data-dir="-1">âˆ’</button><span class="jing-val" id="xi-angang">0</span><button class="jing-btn" data-player="xi" data-type="angang" data-dir="1">+</button></div></div>
          </div>
        </div>
        <div class="player-card" data-player="bei">
          <div class="player-name"><span>åŒ—å®¶</span><span class="badge" id="bei-badge" style="display:none">åº„</span></div>
          <div class="jing-input-row"><span class="jing-label">æ­£ç²¾</span><div class="jing-controls"><button class="jing-btn" data-player="bei" data-type="zheng" data-dir="-1">âˆ’</button><span class="jing-val" id="bei-zheng">0</span><button class="jing-btn" data-player="bei" data-type="zheng" data-dir="1">+</button></div></div>
          <div class="jing-input-row"><span class="jing-label">å‰¯ç²¾</span><div class="jing-controls"><button class="jing-btn" data-player="bei" data-type="fu" data-dir="-1">âˆ’</button><span class="jing-val" id="bei-fu">0</span><button class="jing-btn" data-player="bei" data-type="fu" data-dir="1">+</button></div></div>
          <div class="gang-section">
            <div class="jing-input-row"><span class="jing-label">æ˜æ </span><div class="jing-controls"><button class="jing-btn" data-player="bei" data-type="minggang" data-dir="-1">âˆ’</button><span class="jing-val" id="bei-minggang">0</span><button class="jing-btn" data-player="bei" data-type="minggang" data-dir="1">+</button></div></div>
            <div class="jing-input-row"><span class="jing-label">æš—æ </span><div class="jing-controls"><button class="jing-btn" data-player="bei" data-type="angang" data-dir="-1">âˆ’</button><span class="jing-val" id="bei-angang">0</span><button class="jing-btn" data-player="bei" data-type="angang" data-dir="1">+</button></div></div>
          </div>
        </div>
      </div>
      <div class="bangjin-hint" id="bangjin-hint">åªæœ‰ä¸€å®¶æœ‰ç²¾æ—¶è‡ªåŠ¨è§¦å‘éœ¸ç‹ç²¾</div>
    </div>

    <div class="card">
      <div class="card-title">åº„å®¶</div>
      <div class="zhuang-selector">
        <button class="zhuang-btn" data-zhuang="dong">ä¸œå®¶</button>
        <button class="zhuang-btn active" data-zhuang="nan">å—å®¶</button>
        <button class="zhuang-btn" data-zhuang="xi">è¥¿å®¶</button>
        <button class="zhuang-btn" data-zhuang="bei">åŒ—å®¶</button>
      </div>
    </div>

    <div class="card">
      <div class="card-title">èƒ¡ç‰Œç©å®¶</div>
      <div class="zhuang-selector">
        <button class="hu-btn hu-player" data-hu="dong">ä¸œå®¶</button>
        <button class="hu-btn hu-player active" data-hu="nan">å—å®¶</button>
        <button class="hu-btn hu-player" data-hu="xi">è¥¿å®¶</button>
        <button class="hu-btn hu-player" data-hu="bei">åŒ—å®¶</button>
      </div>
    </div>

    <div class="card">
      <div class="card-title">èƒ¡ç‰Œæ–¹å¼</div>
      <div class="pao-selector">
        <button class="pao-btn" data-pao="dong">ä¸œç‚¹ç‚®</button>
        <button class="pao-btn" data-pao="nan">å—ç‚¹ç‚®</button>
        <button class="pao-btn" data-pao="xi">è¥¿ç‚¹ç‚®</button>
        <button class="pao-btn" data-pao="bei">åŒ—ç‚¹ç‚®</button>
        <button class="pao-btn active" data-pao="none">è‡ªæ‘¸</button>
      </div>
    </div>

    <div class="card">
      <div class="card-title">èƒ¡ç‰Œç±»å‹ï¼ˆå¯å¤šé€‰å åŠ ï¼‰</div>
      <div class="hu-types">
        <button class="hu-btn" data-type="qidui">å°ä¸ƒå¯¹ Ã—2</button>
        <button class="hu-btn" data-type="dqidui">ç¢°ç¢°èƒ¡ Ã—2</button>
        <button class="hu-btn" data-type="shisanlan">åä¸‰çƒ‚ Ã—2</button>
        <button class="hu-btn" data-type="qixing">ä¸ƒæ˜Ÿ â†’Ã—4</button>
        <button class="hu-btn" data-type="jingdiao">ç²¾é’“ Ã—2</button>
        <button class="hu-btn" data-type="gangshang">æ ä¸ŠèŠ± Ã—2</button>
        <button class="hu-btn" data-type="qianggang">æŠ¢æ èƒ¡ Ã—2</button>
        <button class="hu-btn" data-type="tianhu">å¤©èƒ¡ =20</button>
        <button class="hu-btn" data-type="dihu">åœ°èƒ¡ =20</button>
        <button class="hu-btn" data-type="deguo">å¾·å›½ Ã—2+5</button>
        <button class="hu-btn" data-type="gangjin">æ ç²¾ +10/å®¶</button>
      </div>
      <div class="hu-explain" id="hu-explain"></div>
    </div>

    <div class="card result-card">
      <div class="card-title">ç»“ç®—ç»“æœï¼ˆç‚¹å‡»å±•å¼€æ˜ç»†ï¼‰</div>
      <div class="result-table">
        <div class="result-row header"><span>ç©å®¶</span><span style="text-align:right">è¿›å‡ºå­</span></div>

        <div class="result-row" data-player="dong">
          <div class="player-col"><span>ä¸œå®¶</span><span class="badge" id="res-dong-badge" style="display:none">åº„</span></div>
          <span class="score-col" id="res-dong">0</span>
        </div>
        <div class="player-detail" id="detail-dong"></div>

        <div class="result-row" data-player="nan">
          <div class="player-col"><span>å—å®¶</span><span class="badge" id="res-nan-badge" style="display:none">åº„</span></div>
          <span class="score-col" id="res-nan">0</span>
        </div>
        <div class="player-detail" id="detail-nan"></div>

        <div class="result-row" data-player="xi">
          <div class="player-col"><span>è¥¿å®¶</span><span class="badge" id="res-xi-badge" style="display:none">åº„</span></div>
          <span class="score-col" id="res-xi">0</span>
        </div>
        <div class="player-detail" id="detail-xi"></div>

        <div class="result-row" data-player="bei">
          <div class="player-col"><span>åŒ—å®¶</span><span class="badge" id="res-bei-badge" style="display:none">åº„</span></div>
          <span class="score-col" id="res-bei">0</span>
        </div>
        <div class="player-detail" id="detail-bei"></div>
      </div>

      <div class="total-check" id="total-check">æ€»è®¡: 0</div>
    </div>
  </div>

  <div class="action-bar">
    <button class="btn btn-reset" id="btn-reset">é‡ç½®</button>
    <button class="btn btn-share" id="btn-share">å¤åˆ¶æˆ˜ç»©</button>
  </div>

  <div class="toast" id="toast">å·²å¤åˆ¶åˆ°å‰ªè´´æ¿</div>

  <script>
    const players = ['dong', 'nan', 'xi', 'bei'];
    const playerNames = { dong: 'ä¸œ', nan: 'å—', xi: 'è¥¿', bei: 'åŒ—' };

    let state = {
      zhuang: 'nan',
      hu: 'nan',
      pao: 'none',
      huTypes: new Set(),
      players: {
        dong: { zheng: 0, fu: 0, minggang: 0, angang: 0 },
        nan:  { zheng: 0, fu: 0, minggang: 0, angang: 0 },
        xi:   { zheng: 0, fu: 0, minggang: 0, angang: 0 },
        bei:  { zheng: 0, fu: 0, minggang: 0, angang: 0 }
      }
    };

    function calculate() {
      const results = {};
      const details = {};
      players.forEach(p => { results[p] = 0; details[p] = []; });

      const winner = state.hu;
      const dealer = state.zhuang;
      const isZimo = state.pao === 'none';
      const paoPlayer = state.pao;

      // ========== 1. ç²¾ç‰Œåˆ† ==========
      const jingBase = {};
      let totalJingBase = 0;
      const playersWithJing = [];

      players.forEach(p => {
        jingBase[p] = state.players[p].zheng * 2 + state.players[p].fu;
        totalJingBase += jingBase[p];
        if (jingBase[p] > 0) playersWithJing.push(p);
      });

      const isBawang = playersWithJing.length === 1;

      // å†²å…³å€æ•°ï¼šæ€»ç²¾åˆ†>=5æ—¶ï¼Œå€æ•°=æ€»ç²¾åˆ†-3
      const chongguanMulti = totalJingBase >= 5 ? (totalJingBase - 3) : 1;

      // è®¡ç®—æ¯å®¶ç²¾ç‰Œå¾—åˆ†ï¼ˆå†²å…³+éœ¸ç‹ç²¾åï¼‰
      const jingScore = {};
      players.forEach(p => {
        jingScore[p] = jingBase[p];
        if (jingScore[p] > 0) {
          jingScore[p] *= chongguanMulti;
          if (isBawang) jingScore[p] *= 2;
        }
      });

      const totalJingScore = players.reduce((s, p) => s + jingScore[p], 0);

      // ç²¾ç‰Œç»“ç®—ï¼šæ¯å®¶å‡€åˆ† = 4Ã—è‡ªå·±åˆ† - æ€»åˆ†ï¼ˆä¿è¯æ€»å’Œä¸º0ï¼‰
      players.forEach(p => {
        const net = 4 * jingScore[p] - totalJingScore;
        results[p] += net;
        if (net !== 0) {
          let desc = `ç²¾ç‰Œ${jingBase[p]}å­`;
          if (chongguanMulti > 1) desc += ` å†²å…³Ã—${chongguanMulti}`;
          if (isBawang && jingScore[p] > 0) desc += ' éœ¸ç‹Ã—2';
          details[p].push(`ç²¾ç‰Œ: ${net > 0 ? '+' : ''}${net} (${desc})`);
        }
      });

      // æ›´æ–°éœ¸ç‹ç²¾æç¤º
      const hint = document.getElementById('bangjin-hint');
      if (isBawang) {
        hint.textContent = 'éœ¸ç‹ç²¾ï¼š' + playerNames[playersWithJing[0]] + 'å®¶ï¼ˆç²¾åˆ†ç¿»å€ï¼‰';
        hint.classList.add('has-bangjin');
      } else if (chongguanMulti > 1) {
        hint.textContent = 'å†²å…³ï¼šæ€»ç²¾' + totalJingBase + 'å­ Ã—' + chongguanMulti;
        hint.classList.add('has-bangjin');
      } else {
        hint.textContent = 'åªæœ‰ä¸€å®¶æœ‰ç²¾æ—¶è‡ªåŠ¨è§¦å‘éœ¸ç‹ç²¾';
        hint.classList.remove('has-bangjin');
      }

      // ========== 2. æ åˆ† ==========
      // æ˜æ ï¼šå…¶ä»–3å®¶å„ä»˜1å­/æ ï¼Œæš—æ ï¼šå…¶ä»–3å®¶å„ä»˜2å­/æ 
      players.forEach(p => {
        const myGangPer = state.players[p].minggang * 1 + state.players[p].angang * 2;
        if (myGangPer > 0) {
          const income = myGangPer * 3;
          results[p] += income;
          const gangDesc = [];
          if (state.players[p].minggang > 0) gangDesc.push(`æ˜æ ${state.players[p].minggang}`);
          if (state.players[p].angang > 0) gangDesc.push(`æš—æ ${state.players[p].angang}`);
          details[p].push(`æ ç‰Œ: +${income} (${gangDesc.join('+')})`);
        }
        // ä»˜ç»™å…¶ä»–æ è€…
        players.forEach(q => {
          if (q === p) return;
          const qGangPer = state.players[q].minggang * 1 + state.players[q].angang * 2;
          if (qGangPer > 0) {
            results[p] -= qGangPer;
          }
        });
      });
      // ä¿®æ­£æ çš„detailsï¼ˆä»˜å‡ºéƒ¨åˆ†åˆå¹¶æ˜¾ç¤ºï¼‰
      players.forEach(p => {
        const myGangPer = state.players[p].minggang * 1 + state.players[p].angang * 2;
        const othersGang = players.filter(q => q !== p)
          .reduce((s, q) => s + state.players[q].minggang * 1 + state.players[q].angang * 2, 0);
        if (othersGang > 0 && myGangPer === 0) {
          details[p].push(`æ ç‰Œ: -${othersGang}`);
        }
      });

      // æ ç²¾ï¼šèƒ¡ç‰Œè€…æ äº†ç²¾ç‰Œï¼Œå…¶ä»–3å®¶å„ä»˜10
      if (state.huTypes.has('gangjin')) {
        results[winner] += 30;
        details[winner].push('æ ç²¾: +30');
        players.forEach(p => {
          if (p !== winner) {
            results[p] -= 10;
            details[p].push('æ ç²¾: -10');
          }
        });
      }

      // ========== 3. èƒ¡ç‰Œåˆ† ==========
      const hasTianhu = state.huTypes.has('tianhu');
      const hasDihu = state.huTypes.has('dihu');
      const hasDeguo = state.huTypes.has('deguo');
      const hasJingdiao = state.huTypes.has('jingdiao');
      const hasQidui = state.huTypes.has('qidui');
      const hasDqidui = state.huTypes.has('dqidui');
      const hasShisanlan = state.huTypes.has('shisanlan');
      const hasQixing = state.huTypes.has('qixing');
      const hasGangshang = state.huTypes.has('gangshang');
      const hasQianggang = state.huTypes.has('qianggang');

      if (hasTianhu || hasDihu) {
        // å¤©èƒ¡/åœ°èƒ¡ï¼šå›ºå®šé‡‘é¢ï¼Œæ¯å®¶ä»˜20ï¼ˆç²¾é’“æ—¶40ï¼‰
        let fixedPer = 20;
        if (hasJingdiao) fixedPer = 40;

        const huLabel = hasTianhu ? 'å¤©èƒ¡' : 'åœ°èƒ¡';
        let winnerTotal = 0;
        players.forEach(p => {
          if (p !== winner) {
            results[p] -= fixedPer;
            results[winner] += fixedPer;
            winnerTotal += fixedPer;
            details[p].push(`${huLabel}: -${fixedPer}`);
          }
        });
        details[winner].push(`${huLabel}: +${winnerTotal}`);
      } else {
        // è®¡ç®—ç‰Œå‹å€æ•°
        let typeMult = 1;
        const typeDesc = [];

        // è‡ªæ‘¸ Ã—2ï¼ˆç”±èƒ¡ç‰Œæ–¹å¼å†³å®šï¼Œéèƒ¡ç‰Œç±»å‹é€‰æ‹©ï¼‰
        if (isZimo) {
          typeMult *= 2;
          typeDesc.push('è‡ªæ‘¸Ã—2');
        }

        // ä¸ƒæ˜Ÿ+ä¸ƒå¯¹/åä¸‰çƒ‚ = Ã—4ï¼ˆä¸æ˜¯å„è‡ªç‹¬ç«‹å åŠ ï¼‰
        if (hasQixing && (hasQidui || hasDqidui)) {
          typeMult *= 4;
          typeDesc.push('ä¸ƒæ˜Ÿä¸ƒå¯¹Ã—4');
        } else if (hasQixing && hasShisanlan) {
          typeMult *= 4;
          typeDesc.push('ä¸ƒæ˜Ÿåä¸‰çƒ‚Ã—4');
        } else {
          if (hasQidui) { typeMult *= 2; typeDesc.push('å°ä¸ƒå¯¹Ã—2'); }
          if (hasDqidui) { typeMult *= 2; typeDesc.push('ç¢°ç¢°èƒ¡Ã—2'); }
          if (hasShisanlan) { typeMult *= 2; typeDesc.push('åä¸‰çƒ‚Ã—2'); }
          if (hasQixing) { typeMult *= 4; typeDesc.push('ä¸ƒæ˜ŸÃ—4'); }
        }

        if (hasJingdiao) { typeMult *= 2; typeDesc.push('ç²¾é’“Ã—2'); }
        if (hasGangshang) { typeMult *= 2; typeDesc.push('æ ä¸ŠèŠ±Ã—2'); }
        if (hasQianggang) { typeMult *= 2; typeDesc.push('æŠ¢æ Ã—2'); }
        if (hasDeguo) { typeMult *= 2; typeDesc.push('å¾·å›½Ã—2'); }

        // åŸºç¡€èƒ¡ç‰Œåˆ† = 1 Ã— ç‰Œå‹å€æ•°
        const huScore = typeMult;
        const typeDescStr = typeDesc.length > 0 ? typeDesc.join(' ') : 'å±èƒ¡';

        if (isZimo) {
          // === è‡ªæ‘¸ç»“ç®—ï¼šä¸‰å®¶éƒ½ä»˜ ===
          let winnerTotal = 0;
          players.forEach(p => {
            if (p === winner) return;
            let amount = huScore;
            let extra = '';
            // åº„å®¶ä¿®é¥°ï¼šæ¶‰åŠåº„å®¶çš„ä»˜æ¬¾ç¿»å€
            if (p === dealer || winner === dealer) {
              amount *= 2;
              extra = ' åº„Ã—2';
            }
            // å¾·å›½é¢å¤–+5
            if (hasDeguo) {
              amount += 5;
              extra += ' +5';
            }
            results[p] -= amount;
            results[winner] += amount;
            winnerTotal += amount;
            details[p].push(`èƒ¡ç‰Œ: -${amount} (${typeDescStr}${extra})`);
          });
          details[winner].push(`èƒ¡ç‰Œ: +${winnerTotal} (${typeDescStr})`);
        } else if (hasDeguo) {
          // === å¾·å›½ç‚¹ç‚®ï¼šä¸‰å®¶éƒ½ä»˜ï¼Œç‚¹ç‚®è€…é¢å¤–Ã—2+5 ===
          let winnerTotal = 0;
          players.forEach(p => {
            if (p === winner) return;
            let amount = huScore;
            let extra = '';
            if (p === paoPlayer) {
              amount *= 2; // ç‚¹ç‚® Ã—2
              extra = ' ç‚¹ç‚®Ã—2';
            }
            // åº„å®¶ä¿®é¥°
            if (p === dealer || winner === dealer) {
              amount *= 2;
              extra += ' åº„Ã—2';
            }
            // å¾·å›½+5ï¼ˆä»…ç‚¹ç‚®è€…ï¼‰
            if (p === paoPlayer) {
              amount += 5;
              extra += ' +5';
            }
            results[p] -= amount;
            results[winner] += amount;
            winnerTotal += amount;
            details[p].push(`èƒ¡ç‰Œ: -${amount} (${typeDescStr}${extra})`);
          });
          details[winner].push(`èƒ¡ç‰Œ: +${winnerTotal} (${typeDescStr})`);
        } else {
          // === æ™®é€šç‚¹ç‚®ï¼šä»…ç‚¹ç‚®è€…ä»˜æ¬¾ ===
          if (paoPlayer && paoPlayer !== 'none') {
            let amount = huScore * 2; // ç‚¹ç‚® Ã—2
            let extra = 'ç‚¹ç‚®Ã—2';
            // åº„å®¶ä¿®é¥°
            if (paoPlayer === dealer || winner === dealer) {
              amount *= 2;
              extra += ' åº„Ã—2';
            }
            results[paoPlayer] -= amount;
            results[winner] += amount;
            details[paoPlayer].push(`ç‚¹ç‚®: -${amount} (${typeDescStr} ${extra})`);
            details[winner].push(`èƒ¡ç‰Œ: +${amount} (${typeDescStr} ${extra})`);
          }
        }
      }

      updateResults(results, details);
    }

    function updateResults(results, details) {
      let total = 0;

      players.forEach(p => {
        const s = results[p];
        total += s;

        const el = document.getElementById('res-' + p);
        el.textContent = (s >= 0 ? '+' : '') + s;
        el.className = 'score-col ' + (s > 0 ? 'positive' : s < 0 ? 'negative' : '') + (p === state.zhuang ? ' zhuang' : '');

        const detailEl = document.getElementById('detail-' + p);
        if (details[p].length > 0) {
          detailEl.innerHTML = details[p].map(d => `<div class="row"><span>${d}</span></div>`).join('');
        } else {
          detailEl.innerHTML = '<div class="row"><span>æ— å˜åŠ¨</span></div>';
        }
      });

      // åº„å®¶æ ‡è®°
      players.forEach(p => {
        document.getElementById(p + '-badge').style.display = (p === state.zhuang) ? 'inline' : 'none';
        document.getElementById('res-' + p + '-badge').style.display = (p === state.zhuang) ? 'inline' : 'none';
      });

      const totalEl = document.getElementById('total-check');
      totalEl.textContent = 'æ€»è®¡: ' + total + (total === 0 ? ' \u2713' : ' \u2717 (è®¡ç®—å¼‚å¸¸)');
      totalEl.className = 'total-check ' + (total === 0 ? 'valid' : 'invalid');
    }

    // ç²¾ç‰Œ/æ ç‰ŒæŒ‰é’®äº‹ä»¶
    document.querySelectorAll('.jing-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const p = btn.dataset.player, t = btn.dataset.type, d = parseInt(btn.dataset.dir);
        const max = (t === 'zheng' || t === 'fu') ? 4 : 10;
        state.players[p][t] = Math.max(0, Math.min(max, state.players[p][t] + d));
        document.getElementById(p + '-' + t).textContent = state.players[p][t];
        calculate();
      });
    });

    // åº„å®¶é€‰æ‹©
    document.querySelectorAll('.zhuang-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.zhuang-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        state.zhuang = btn.dataset.zhuang;
        calculate();
      });
    });

    // ç‚¹ç‚®é€‰æ‹©
    document.querySelectorAll('.pao-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.pao-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        state.pao = btn.dataset.pao;
        calculate();
      });
    });

    // èƒ¡ç‰Œç©å®¶é€‰æ‹©
    document.querySelectorAll('.hu-player').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.hu-player').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        state.hu = btn.dataset.hu;
        calculate();
      });
    });

    // èƒ¡ç‰Œç±»å‹ï¼ˆäº’æ–¥å¤„ç†ï¼‰
    const exclusiveGroups = {
      qidui: ['dqidui', 'shisanlan'],
      dqidui: ['qidui', 'shisanlan'],
      shisanlan: ['qidui', 'dqidui'],
      tianhu: ['dihu'],
      dihu: ['tianhu']
    };

    const huExplains = {
      qidui: 'å°ä¸ƒå¯¹ï¼šæ‰‹ç‰Œç”±7ç»„å¯¹å­ç»„æˆï¼Œä¸èƒ½æœ‰åƒç¢°æ ã€‚èƒ¡ç‰Œå€æ•°Ã—2ã€‚',
      dqidui: 'ç¢°ç¢°èƒ¡ï¼š4ç»„åˆ»å­ï¼ˆæˆ–æ ï¼‰+ 1å¯¹é›€å¤´ï¼Œæ²¡æœ‰é¡ºå­ã€‚èƒ¡ç‰Œå€æ•°Ã—2ã€‚',
      shisanlan: 'åä¸‰çƒ‚ï¼šä¸‡æ¡ç­’æ¯å¼ ç‰Œåœ¨åŒèŠ±è‰²ä¸­é—´éš”â‰¥2ï¼Œå­—ç‰Œä¸é‡å¤ï¼Œä¸èƒ½åƒç¢°æ ã€‚èƒ¡ç‰Œå€æ•°Ã—2ã€‚',
      qixing: 'ä¸ƒæ˜Ÿï¼šåœ¨å°ä¸ƒå¯¹æˆ–åä¸‰çƒ‚åŸºç¡€ä¸Šï¼Œé›†é½ä¸œå—è¥¿åŒ—ä¸­å‘ç™½7å¼ å­—ç‰Œã€‚èƒ¡ç‰Œå€æ•°Ã—4ï¼ˆæ›¿ä»£åŸºç¡€ç‰Œå‹çš„Ã—2ï¼‰ã€‚',
      jingdiao: 'ç²¾é’“ï¼šæ‰‹ä¸­åªå‰©1å¼ ç‰Œæ—¶èƒ¡ç‰Œï¼Œä¸”è¯¥ç‰Œä¸ºç²¾ç‰Œï¼ˆä¸‡èƒ½ç‰Œï¼‰ã€‚èƒ¡ç‰Œå€æ•°Ã—2ï¼Œå åŠ è‡ªæ‘¸ã€‚',
      gangshang: 'æ ä¸Šå¼€èŠ±ï¼šæ ç‰Œåè¡¥ç‰Œæ—¶è‡ªæ‘¸èƒ¡ç‰Œã€‚èƒ¡ç‰Œå€æ•°Ã—2ï¼Œå åŠ è‡ªæ‘¸ã€‚',
      qianggang: 'æŠ¢æ èƒ¡ï¼šå…¶ä»–ç©å®¶è¡¥æ æ—¶ï¼Œä½ æ°å¥½èƒ½èƒ¡è¯¥ç‰Œã€‚èƒ¡ç‰Œå€æ•°Ã—2ã€‚',
      tianhu: 'å¤©èƒ¡ï¼šåº„å®¶èµ·æ‰‹14å¼ ç›´æ¥èƒ¡ç‰Œã€‚å›ºå®šæ¯å®¶ä»˜20å­ï¼ˆç²¾é’“æ—¶40å­ï¼‰ã€‚',
      dihu: 'åœ°èƒ¡ï¼šåº„å®¶æ‰“å‡ºçš„ç¬¬ä¸€å¼ ç‰Œè¢«é—²å®¶èƒ¡ã€‚å›ºå®šæ¯å®¶ä»˜20å­ï¼ˆç²¾é’“æ—¶40å­ï¼‰ã€‚',
      deguo: 'å¾·å›½ï¼šèƒ¡ç‰Œæ—¶æ‰‹ä¸­æ— ç²¾ç‰Œï¼Œæˆ–ç²¾ç‰Œæœªå½“ä¸‡èƒ½ç‰Œä½¿ç”¨ã€‚è‡ªæ‘¸ä¸‰å®¶å„+5ï¼Œç‚¹ç‚®æ—¶ä¸‰å®¶éƒ½ä»˜ã€ç‚¹ç‚®è€…é¢å¤–Ã—2+5ã€‚',
      gangjin: 'æ ç²¾ï¼šå°†4å¼ ç²¾ç‰Œå¼€æ ã€‚å…¶ä»–ä¸‰å®¶å„ä»˜10å­ï¼ˆç‹¬ç«‹äºèƒ¡ç‰Œåˆ†è®¡ç®—ï¼‰ã€‚'
    };

    const explainEl = document.getElementById('hu-explain');

    document.querySelectorAll('.hu-btn:not(.hu-player)').forEach(btn => {
      btn.addEventListener('click', () => {
        const t = btn.dataset.type;
        if (state.huTypes.has(t)) {
          // å–æ¶ˆé€‰ä¸­ â†’ éšè—è§£é‡Š
          state.huTypes.delete(t);
          btn.classList.remove('active');
          explainEl.classList.remove('show');
        } else {
          // é€‰ä¸­ â†’ æ˜¾ç¤ºè¯¥ç±»å‹è§£é‡Š
          state.huTypes.add(t);
          btn.classList.add('active');
          if (huExplains[t]) {
            explainEl.textContent = huExplains[t];
            explainEl.classList.add('show');
          }
          // å¤„ç†äº’æ–¥
          if (exclusiveGroups[t]) {
            exclusiveGroups[t].forEach(ex => {
              state.huTypes.delete(ex);
              document.querySelector(`.hu-btn[data-type="${ex}"]`).classList.remove('active');
            });
          }
        }
        calculate();
      });
    });

    // ç‚¹å‡»å±•å¼€æ˜ç»†
    document.querySelectorAll('.result-row[data-player]').forEach(row => {
      row.addEventListener('click', () => {
        const p = row.dataset.player;
        document.getElementById('detail-' + p).classList.toggle('show');
      });
    });

    // é‡ç½®
    document.getElementById('btn-reset').addEventListener('click', () => {
      state = {
        zhuang: 'nan', hu: 'nan', pao: 'none', huTypes: new Set(),
        players: {
          dong: { zheng: 0, fu: 0, minggang: 0, angang: 0 },
          nan:  { zheng: 0, fu: 0, minggang: 0, angang: 0 },
          xi:   { zheng: 0, fu: 0, minggang: 0, angang: 0 },
          bei:  { zheng: 0, fu: 0, minggang: 0, angang: 0 }
        }
      };
      players.forEach(p => {
        ['zheng', 'fu', 'minggang', 'angang'].forEach(t => {
          document.getElementById(p + '-' + t).textContent = 0;
        });
      });
      document.querySelectorAll('.zhuang-btn').forEach(b => b.classList.remove('active'));
      document.querySelector('.zhuang-btn[data-zhuang="nan"]').classList.add('active');
      document.querySelectorAll('.hu-player').forEach(b => b.classList.remove('active'));
      document.querySelector('.hu-player[data-hu="nan"]').classList.add('active');
      document.querySelectorAll('.pao-btn').forEach(b => b.classList.remove('active'));
      document.querySelector('.pao-btn[data-pao="none"]').classList.add('active');
      document.querySelectorAll('.hu-btn:not(.hu-player)').forEach(b => b.classList.remove('active'));
      document.getElementById('hu-explain').classList.remove('show');
      document.querySelectorAll('.player-detail').forEach(d => d.classList.remove('show'));
      document.querySelectorAll('.gang-section').forEach(s => s.classList.remove('show'));
      document.getElementById('toggle-gang').textContent = 'æ˜¾ç¤ºæ ç‰Œ';
      calculate();
    });

    // å¤åˆ¶æˆ˜ç»©
    document.getElementById('btn-share').addEventListener('click', async () => {
      const lines = ['å—æ˜Œéº»å°†ç»“ç®—', 'â”€â”€â”€â”€â”€â”€â”€â”€'];
      players.forEach(p => {
        const s = document.getElementById('res-' + p).textContent;
        const z = p === state.zhuang ? ' [åº„]' : '';
        const h = p === state.hu ? ' [èƒ¡]' : '';
        lines.push(playerNames[p] + 'å®¶' + z + h + ': ' + s);
      });
      lines.push('â”€â”€â”€â”€â”€â”€â”€â”€');
      const method = state.pao === 'none' ? 'è‡ªæ‘¸' : playerNames[state.pao] + 'ç‚¹ç‚®';
      lines.push('åº„:' + playerNames[state.zhuang] + ' èƒ¡:' + playerNames[state.hu] + ' ' + method);
      if (state.huTypes.size > 0) {
        const typeLabels = {
          qidui:'å°ä¸ƒå¯¹', dqidui:'ç¢°ç¢°èƒ¡', shisanlan:'åä¸‰çƒ‚', qixing:'ä¸ƒæ˜Ÿ',
          jingdiao:'ç²¾é’“', gangshang:'æ ä¸ŠèŠ±', qianggang:'æŠ¢æ èƒ¡',
          tianhu:'å¤©èƒ¡', dihu:'åœ°èƒ¡', deguo:'å¾·å›½', gangjin:'æ ç²¾'
        };
        lines.push('ç±»å‹: ' + Array.from(state.huTypes).map(t => typeLabels[t] || t).join(', '));
      }

      try {
        await navigator.clipboard.writeText(lines.join('\n'));
        const toast = document.getElementById('toast');
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 2000);
      } catch(e) {}
    });

    // ä¸»é¢˜åˆ‡æ¢
    const themes = ['mahjong', 'festive', 'dark'];
    const themeLabels = { mahjong: 'ğŸ€„', festive: 'ğŸ§§', dark: 'ğŸŒ™' };
    const themeColors = { mahjong: '#1b4332', festive: '#b91c1c', dark: '#27272a' };

    function applyTheme(t) {
      document.documentElement.setAttribute('data-theme', t);
      document.getElementById('meta-theme').setAttribute('content', themeColors[t]);
      document.getElementById('theme-toggle').textContent = themeLabels[t];
      localStorage.setItem('mj-theme', t);
    }

    document.getElementById('theme-toggle').addEventListener('click', () => {
      const cur = localStorage.getItem('mj-theme') || 'mahjong';
      const next = themes[(themes.indexOf(cur) + 1) % themes.length];
      applyTheme(next);
    });

    applyTheme(localStorage.getItem('mj-theme') || 'mahjong');

    calculate();
  </script>
</body>
</html>
